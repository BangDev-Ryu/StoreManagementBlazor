@page "/customers"
@using System.Globalization
@using StoreManagementBlazor.Models
@using StoreManagementBlazor.Services
@inject CustomerService CustomerService
@* @inject NavigationManager Navigation *@

@rendermode InteractiveServer



<div class="container-fluid mt-3">
    <h2>Quản lý khách hàng</h2>

    <!-- FILTER FORM -->
    <div class="row g-2 align-items-end mb-3">

        <!-- SEARCH -->
        <div class="col-md-4">
            <label class="form-label">Tìm kiếm</label>
            <input class="form-control"
                   placeholder="Tìm theo tên khách hàng"
                   value="@searchText"
                   @oninput="OnSearchInput" />
        </div>

        <!-- SORT -->
        <div class="col-auto">
            <label class="form-label">Sắp xếp</label>
            <select class="form-select"
                    @bind="sortBy"
                    @bind:after="ApplyFilter">
                <option value="">Mặc định (ID)</option>
                <option value="name_asc">Tên A→Z</option>
                <option value="name_desc">Tên Z→A</option>
            </select>
        </div>

        <!-- PAGE SIZE -->
        <div class="col-auto">
            <label for="pageSizeSelect" class="form-label">Số dòng / trang</label>
            <select id="pageSizeSelect" class="form-select"
                    @bind="pageSize"
                    @bind:after="ApplyFilter">
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
            </select>
        </div>

        <!-- BUTTONS -->
        <div class="col-auto">
            <button class="btn btn-primary" @onclick="ApplyFilter">Lọc</button>
            <button class="btn btn-outline-secondary" @onclick="ResetFilter">Đặt lại</button>
        </div>
    </div>

    <p>
        <a class="btn btn-primary" href="/customers/create">Thêm khách hàng</a>
    </p>

    <!-- DATA TABLE -->
    <table class="table table-striped align-middle">
        <thead>
            <tr>
                <th>#</th>
                <th>Tên khách hàng</th>
                <th>Số điện thoại</th>
                <th>Email</th>
                <th>Địa chỉ</th>
                <th>Thời gian tạo</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @if (customers == null || customers.Count == 0)
            {
                <tr>
                    <td colspan="7">Không có dữ liệu khách hàng.</td>
                </tr>
            }
            else
            {
                @foreach (var i in customers)
                {
                    <tr>
                        <td>@i.CustomerId</td>
                        <td>@i.Name</td>
                        <td>@i.Phone</td>
                        <td>@i.Email</td>
                        <td>@i.Address</td>
                        <td>@i.CreatedAt.ToString("HH:mm:ss dd/MM/yyyy")</td>

                        <td class="text-center">
                            <a class="btn btn-sm btn-outline-primary" href="/customers/edit/@i.CustomerId">Cập nhật</a>
                            <a class="btn btn-sm btn-outline-secondary" href="/customers/details/@i.CustomerId">Chi tiết</a>
                            <a class="btn btn-sm btn-outline-danger" href="/customers/delete/@i.CustomerId">Xóa</a>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>

    <!-- PAGINATION -->
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">

            <li class="page-item @(currentPage <= 1 ? "disabled" : "")">
                <a class="page-link" @onclick="() => ChangePage(currentPage - 1)">&laquo; Prev</a>
            </li>

            @for (int p = 1; p <= totalPages; p++)
            {
                if (p == 1 || p == totalPages || (p >= currentPage - 2 && p <= currentPage + 2))
                {
                    <li class="page-item @(p == currentPage ? "active" : "")">
                        <a class="page-link" @onclick="() => ChangePage(p)">@p</a>
                    </li>
                }
                else if (p == 2 && currentPage > 4)
                {
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                }
                else if (p == totalPages - 1 && currentPage < totalPages - 3)
                {
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                }
            }

            <li class="page-item @(currentPage >= totalPages ? "disabled" : "")">
                <a class="page-link" @onclick="() => ChangePage(currentPage + 1)">Next &raquo;</a>
            </li>

        </ul>
    </nav>
</div>

@code {

    // data
    List<Customer> customers = new();

    // filter states
    string? searchText = "";
    string? sortBy = "";
    int pageSize = 5;
    int currentPage = 1;
    int totalPages = 1;
    int totalCount = 0;

    // debounce
    private System.Timers.Timer? debounceTimer;

    protected override async Task OnInitializedAsync()
    {
        // setup debounce timer
        debounceTimer = new System.Timers.Timer(600);
        debounceTimer.AutoReset = false;
        debounceTimer.Elapsed += async (_, __) =>
        {
            currentPage = 1;
            await LoadData();
            await InvokeAsync(StateHasChanged);
        };

        await LoadData();
    }

    async Task LoadData()
    {
        var result = await CustomerService.GetAll(
            search: searchText,
            sortBy: sortBy,
            page: currentPage,
            pageSize: pageSize
        );

        customers = result.Customers;
        totalCount = result.TotalCount;

        totalPages = (int)Math.Ceiling((double)totalCount / pageSize);
    }

    async Task ChangePage(int page)
    {
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        await LoadData();
    }

    async Task ApplyFilter()
    {
        currentPage = 1;
        await LoadData();
    }


    async Task ResetFilter()
    {
        searchText = "";
        sortBy = "";
        pageSize = 5;
        currentPage = 1;

        await LoadData();
    }


    void DebounceSearch(ChangeEventArgs e)
    {
        searchText = e.Value?.ToString() ?? "";
        debounceTimer.Stop();
        debounceTimer.Start();
    }

    void OnSearchInput(ChangeEventArgs e)
    {
        searchText = e.Value?.ToString() ?? "";
        DebounceSearch(e);
    }
}
