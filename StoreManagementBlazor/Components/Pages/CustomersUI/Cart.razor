@page "/cart"
@rendermode InteractiveServer
@inject CartService CartService
@inject NavigationManager Nav

<div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Giỏ hàng</h5>
        <a href="/shopping" class="btn btn-outline-secondary">Quay lại mua sắm</a>
    </div>

    <div class="card-body">
        @if (items == null || !items.Any())
        {
            <p class="text-center text-muted">Giỏ hàng trống</p>
        }
        else
        {
            <table class="table table-bordered align-middle">
                <thead class="table-light">
                    <tr>
                        <th class="text-center">Chọn</th>
                        <th>STT</th>
                        <th>Sản phẩm</th>
                        <th>Giá</th>
                        <th class="text-center">Số lượng</th>
                        <th>Thành tiền</th>
                    </tr>
                </thead>
                <tbody>
                    @for (int i = 0; i < items.Count; i++)
                    {
                        var item = items[i];
                        <tr>
                            <td class="text-center">
                                <input type="checkbox" @bind="item.IsSelected" />
                            </td>
                            <td>@(i + 1)</td>
                            <td>@item.Product?.ProductName</td>
                            <td>@item.Price.ToString("N0") đ</td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-outline-danger me-2" @onclick="() => Decrease(item.ProductId)">−</button>
                                <strong>@item.Quantity</strong>
                                <button class="btn btn-sm btn-outline-success ms-2" @onclick="() => Increase(item.ProductId)">+</button>
                            </td>
                            <td>@item.Subtotal.ToString("N0") đ</td>
                        </tr>
                    }
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="5" class="text-end fw-bold">Tổng tiền</td>
                        <td class="fw-bold">@items.Where(x => x.IsSelected).Sum(x => x.Subtotal).ToString("N0") đ</td>
                    </tr>
                </tfoot>
            </table>

            <button class="btn btn-outline-secondary" @onclick="ProceedToPayment">Thanh toán</button>
            <button class="btn btn-secondary ms-2" @onclick="ClearCart">Xóa giỏ</button>
        }
    </div>
</div>

@code {
    List<CartItem> items = new();

    protected override async Task OnInitializedAsync()
    {
        items = await CartService.GetCartItemsAsync();
    }

    async Task Increase(int productId)
    {
        await CartService.IncreaseAsync(productId);
        items = await CartService.GetCartItemsAsync();
    }

    async Task Decrease(int productId)
    {
        await CartService.DecreaseAsync(productId);
        items = await CartService.GetCartItemsAsync();
    }

    async Task ClearCart()
    {
        await CartService.ClearAsync();
        items = new List<CartItem>();
    }

    void ProceedToPayment()
    {
        var selectedItems = items.Where(x => x.IsSelected).ToList();

        if (!selectedItems.Any())
        {
            Console.WriteLine("Vui lòng chọn sản phẩm trước khi thanh toán.");
            return;
        }

        CartService.SetSelectedItems(selectedItems);
        Nav.NavigateTo("/payment");
    }
}
