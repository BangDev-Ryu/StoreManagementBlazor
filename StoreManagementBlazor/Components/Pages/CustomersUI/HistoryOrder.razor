@page "/history_order"
@rendermode InteractiveServer
@attribute [Authorize]

@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using StoreManagementBlazor.Models.ViewModels
@using Microsoft.AspNetCore.Authorization

@inject OrdersService OrdersService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav

<PageTitle>L·ªãch s·ª≠ ƒë∆°n h√†ng</PageTitle>

<div class="container mt-4">
    <h3 class="mb-3">üßæ L·ªãch s·ª≠ ƒë∆°n h√†ng c·ªßa b·∫°n</h3>

    <!-- T√¨m ki·∫øm + page size -->
    <div class="row g-3 align-items-end mb-3">
        <div class="col-md-4">
            <label class="form-label">T√¨m theo m√£ ƒë∆°n</label>
            <input class="form-control"
                   placeholder="Nh·∫≠p m√£ ƒë∆°n..."
                   @bind="searchText"
                   @oninput="OnSearchInput" />
        </div>

        <div class="col-md-2">
            <label class="form-label">S·ªë d√≤ng / trang</label>
            <select class="form-select" @onchange="OnPageSizeChanged">
                <option value="5" selected="@(pageSize == 5)">5</option>
                <option value="10" selected="@(pageSize == 10)">10</option>
                <option value="20" selected="@(pageSize == 20)">20</option>
            </select>
        </div>
    </div>

    <!-- Table -->
    <div class="table-responsive">
        <table class="table table-bordered align-middle">
            <thead class="table-light">
                <tr>
                    <th>STT</th>
                    <th>M√£ ƒë∆°n</th>
                    <th>Ng√†y ƒë·∫∑t</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th class="text-end">Gi·∫£m gi√°</th>
                    <th class="text-end">T·ªïng ti·ªÅn</th>
                    <th class="text-center">Chi ti·∫øt</th>
                </tr>
            </thead>
            <tbody>
                @if (!orders.Any())
                {
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o
                        </td>
                    </tr>
                }
                else
                {
                    int stt = (currentPage - 1) * pageSize + 1;
                    foreach (var o in orders)
                    {
                        <tr>
                            <td>@stt</td>
                            <td>#@o.OrderId</td>
                            <td>@o.OrderDate.ToString("dd/MM/yyyy HH:mm")</td>
                            <td>
                                <span class="badge bg-@GetStatusClass(o.Status)">
                                    @GetStatusText(o.Status)
                                </span>
                            </td>
                            <td class="text-end">@o.DiscountAmount.ToString("N0") ƒë</td>
                            <td class="text-end fw-bold text-danger">
                                @o.TotalAmount.ToString("N0") ƒë
                            </td>
                            <td class="text-center">
                                <NavLink class="btn btn-sm btn-info"
                                         href="@($"/orders_details/{o.OrderId}")">
                                    Xem
                                </NavLink>
                            </td>
                        </tr>
                        stt++;
                    }
                }
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <nav>
        <ul class="pagination justify-content-center">
            <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                <button class="page-link" @onclick="() => ChangePage(currentPage - 1)">
                    &laquo;
                </button>
            </li>

            @for (int i = 1; i <= totalPages; i++)
            {
                <li class="page-item @(i == currentPage ? "active" : "")">
                    <button class="page-link" @onclick="() => ChangePage(i)">
                        @i
                    </button>
                </li>
            }

            <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                <button class="page-link" @onclick="() => ChangePage(currentPage + 1)">
                    &raquo;
                </button>
            </li>
        </ul>
    </nav>
</div>

@code {
    private List<OrderListDTO> orders = new();
    private string searchText = "";
    private int currentPage = 1;
    private int pageSize = 5;
    private int totalPages = 1;
    private int totalCount = 0;
    private int customerId;

    private System.Timers.Timer? _debounceTimer;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        customerId = int.Parse(
            user.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? "0"
        );

        _debounceTimer = new System.Timers.Timer(500);
        _debounceTimer.AutoReset = false;
        _debounceTimer.Elapsed += async (_, _) =>
        {
            await InvokeAsync(async () =>
            {
                currentPage = 1;
                await LoadData();
                StateHasChanged();
            });
        };

        await LoadData();
    }

    private async Task LoadData()
    {
        var result = await OrdersService.GetCustomerOrderHistoryAsync(
            customerId,
            currentPage,
            pageSize,
            searchText);

        orders = result.Orders;
        totalCount = result.TotalCount;
        totalPages = (int)Math.Ceiling((double)totalCount / pageSize);
        if (totalPages < 1) totalPages = 1;
    }

    private void OnSearchInput(ChangeEventArgs e)
    {
        searchText = e.Value?.ToString() ?? "";
        _debounceTimer?.Stop();
        _debounceTimer?.Start();
    }

    private async Task OnPageSizeChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int size))
        {
            pageSize = size;
            currentPage = 1;
            await LoadData();
        }
    }

    private async Task ChangePage(int page)
    {
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        await LoadData();
    }

    // ================== STATUS MAPPING ==================

    private string GetStatusText(string status)
    {
        return status switch
        {
            "pending" => "Ch∆∞a thanh to√°n",
            "paid" => "ƒê√£ thanh to√°n",
            "canceled" => "ƒê√£ h·ªßy",
            _ => status
        };
    }

    private string GetStatusClass(string status)
    {
        return status switch
        {
            "pending" => "warning",
            "paid" => "success",
            "canceled" => "danger",
            _ => "light"
        };
    }
}
