@page "/payments/delete/{PaymentId:int}"
@using StoreManagementBlazor.Models
@using StoreManagementBlazor.Services
@inject PaymentsService PaymentsService
@inject NavigationManager NavigationManager

<PageTitle>Xóa thanh toán #@PaymentId</PageTitle>

<h2>Xóa thanh toán #@PaymentId</h2>

@if (ErrorMessage != null)
{
    <div class="alert alert-danger">@ErrorMessage</div>
}

@if (Payment == null && !IsLoading)
{
    <div class="alert alert-danger">Không tìm thấy giao dịch thanh toán #@PaymentId.</div>
}
else if (IsLoading)
{
    <p><em>Đang tải dữ liệu...</em></p>
}
else
{
    <div class="alert alert-warning">
        <p>Bạn có chắc chắn muốn xóa giao dịch thanh toán này?</p>
        <hr/>
        <p><strong>ID Thanh toán:</strong> @Payment!.PaymentId</p>
        <p><strong>Đơn hàng:</strong> #@Payment.OrderId</p>
        <p><strong>Khách hàng:</strong> @(Payment.Order?.Customer?.Name ?? "Khách lẻ")</p>
        <p><strong>Số tiền:</strong> @Payment.Amount.ToString("N0")₫</p>
        <p><strong>Phương thức:</strong> @Payment.PaymentMethod</p>
        <p class="mt-3">**LƯU Ý:** Thao tác này sẽ đặt lại trạng thái Đơn hàng **#@Payment.OrderId** về **'Chờ thanh toán'**.</p>
    </div>

    <EditForm OnSubmit="HandleDelete">
        <button type="submit" class="btn btn-danger" disabled="@IsLoading">
            <span class="spinner-border spinner-border-sm" hidden="@(!IsLoading)"></span>
            Xóa Giao Dịch
        </button>
        <a href="/payments" class="btn btn-secondary">Hủy</a>
    </EditForm>
}

@code {
    [Parameter]
    public int PaymentId { get; set; }

    private Payment? Payment;
    private bool IsLoading = true;
    private string? ErrorMessage;

    protected override async Task OnInitializedAsync()
    {
        IsLoading = true;
        Payment = await PaymentsService.GetPaymentDetailsAsync(PaymentId);
        IsLoading = false;
    }

    private async Task HandleDelete()
    {
        if (Payment == null) return;

        IsLoading = true;
        ErrorMessage = null;

        var (success, message) = await PaymentsService.DeletePaymentAsync(PaymentId);

        if (success)
        {
            // Chuyển hướng về trang Index với thông báo thành công
            NavigationManager.NavigateTo($"/payments?success={Uri.EscapeDataString(message)}", forceLoad: true);
        }
        else
        {
            ErrorMessage = message;
            IsLoading = false;
        }
    }
}