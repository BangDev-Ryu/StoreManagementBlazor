@page "/promotions"
@using System.Globalization
@using StoreManagementBlazor.Models
@using StoreManagementBlazor.Services
@inject PromotionService PromotionService

@rendermode InteractiveServer

<PageTitle>Promotions</PageTitle>

<div class="container-fluid mt-3" style="user-select: none;">
    <h2>Khuyến mãi</h2>

    <div class="row w-100 g-4 align-items-end mb-3">
        <div class="col-md-4">
            <label for="inputSearch" class="form-label">Tìm kiếm</label>
            <input type="text" autocomplete="off" class="form-control" id="inputSearch"
                   @bind="searchText"
                   @oninput="OnSearchInput"
                   placeholder="Mã khuyến mãi...">
        </div>

        <div class="col-auto">
            <label for="startDate" class="form-label">Từ ngày</label>
            <input type="date" class="form-control" id="startDate" @bind="startDate">
        </div>

        <div class="col-auto">
            <label for="endDate" class="form-label">Đến ngày</label>
            <input type="date" class="form-control" id="endDate" @bind="endDate">
        </div>

        <div class="col-auto">
            <label for="pageSizeSelect" class="form-label">Số dòng / trang</label>
            <select id="pageSizeSelect" class="form-select" @onchange="OnPageSizeChanged">
                <option value="5" selected="@(pageSize == 5)">5</option>
                <option value="10" selected="@(pageSize == 10)">10</option>
                <option value="25" selected="@(pageSize == 25)">25</option>
                <option value="50" selected="@(pageSize == 50)">50</option>
            </select>
        </div>

        <div class="col-auto">
            <button class="btn btn-primary"
                    @onclick="LoadData">Lọc</button>
            <button class="btn btn-outline-secondary" 
                    @onclick="ResetFilter">Đặt lại</button>
        </div>
    </div>

    <p>
        <NavLink class="btn btn-primary" href="/promotions/create">Tạo mã khuyến mãi</NavLink>
    </p>

    <div class="table-responsive">
        <table class="table table-striped align-middle table-hover select-none">
            <thead>
                <tr>
                    <th>Mã</th>
                    <th>Loại giảm giá</th>
                    <th>Giá trị</th>
                    <th>Thời gian áp dụng</th>
                    <th>Trạng thái</th>
                    <th class="text-center">Hành động</th>
                </tr>
            </thead>
            <tbody>
                @if (paginatedPromotions == null || !paginatedPromotions.Any())
                {
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            @(hasFilter ? "Không có khuyến mãi phù hợp với bộ lọc." : "Chưa có dữ liệu khuyến mãi.")
                        </td>
                    </tr>
                }
                else
                {
                    foreach (var p in paginatedPromotions)
                    {
                        <tr>
                            <td>@p.PromoCode</td>
                            <td>@(p.DiscountType == "fixed" ? "Số tiền" : "Phần trăm (%)")</td>
                            <td>
                                @if (p.DiscountType == "fixed")
                                {
                                    @p.DiscountValue?.ToString("N0", new CultureInfo("vi-VN"))
                                }
                                else
                                {
                                    @($"{p.DiscountValue:N0}%")
                                }
                            </td>
                            <td>
                                @p.StartDate.ToString("dd/MM/yyyy") - @p.EndDate.ToString("dd/MM/yyyy")
                            </td>
                            <td>
                                @(p.Status == "active" ? "Đang hoạt động" : "Ngưng hoạt động")
                            </td>
                            <td class="text-center align-middle">
                                <NavLink class="btn btn-info" href="@($"/promotions/details/{p.PromoId}")">Chi tiết</NavLink>
                                <NavLink class="btn btn-warning" href="@($"/promotions/edit/{p.PromoId}")">Sửa</NavLink>
                                <NavLink class="btn btn-danger" href="@($"/promotions/delete/{p.PromoId}")">Xóa</NavLink>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">

            <!-- Prev -->
            <li class="page-item @(currentPage <= 1 ? "disabled" : "")">
                <button type="button" class="page-link"
                        style="outline:none !important; box-shadow:none !important;"
                        @onclick="() => ChangePage(currentPage - 1)"
                        disabled="@(currentPage <= 1)">
                    &laquo; Prev
                </button>
            </li>

            @{
                for (int i = 1; i <= totalPages; i++)
                {
                    int pageNumber = i; 

                    if (pageNumber == 1 || pageNumber == totalPages ||
                    (pageNumber >= currentPage - 2 && pageNumber <= currentPage + 2))
                    {
                        <li class="page-item @(pageNumber == currentPage ? "active" : "")">
                            <button type="button" class="page-link"
                                    style="outline:none !important; box-shadow:none !important;"
                                    @onclick="() => ChangePage(pageNumber)">
                                @pageNumber
                            </button>
                        </li>
                    }
                    else if (pageNumber == currentPage - 3 && currentPage > 4)
                    {
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                    }
                    else if (pageNumber == currentPage + 3 && currentPage < totalPages - 3)
                    {
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                    }
                }
            }

            <!-- Next -->
            <li class="page-item @(currentPage >= totalPages ? "disabled" : "")">
                <button type="button" class="page-link"
                        style="outline:none !important; box-shadow:none !important;"
                        @onclick="() => ChangePage(currentPage + 1)"
                        disabled="@(currentPage >= totalPages)">
                    Next &raquo;
                </button>
            </li>

        </ul>
    </nav>
</div>

@code {
    private List<Promotion> allPromotions = new(); // Dữ liệu gốc
    private List<Promotion> filteredPromotions = new(); // Dữ liệu sau khi lọc
    private List<Promotion> paginatedPromotions = new(); // Dữ liệu hiển thị trên trang hiện tại

    // Các biến Filter
    private string searchText = "";
    private DateTime? startDate;
    private DateTime? endDate;
    private bool hasFilter => !string.IsNullOrEmpty(searchText) || startDate.HasValue || endDate.HasValue;

    // Các biến Pagination
    private int currentPage = 1;
    private int pageSize = 5;
    private int totalPages = 1;

    // Timer để Debounce (chờ người dùng gõ xong mới tìm)
    private System.Timers.Timer? _debounceTimer;

    // === Lifecycle ===
    protected override async Task OnInitializedAsync()
    {
        // Khởi tạo timer debounce (500ms)
        _debounceTimer = new System.Timers.Timer(500);
        _debounceTimer.AutoReset = false;
        _debounceTimer.Elapsed += async (sender, e) =>
        {
            await InvokeAsync(() => { LoadData(); StateHasChanged(); });
        };

        // Lấy toàn bộ dữ liệu lần đầu
        await LoadFullData();
    }

    private async Task LoadFullData()
    {
        // Nếu dữ liệu quá lớn => chuyển logic lọc/phân trang xuống Service/DB (SQL)
        allPromotions = await PromotionService.GetAll();
        LoadData(); 
    }

    private void LoadData()
    {
        var query = allPromotions.AsQueryable();

        if (!string.IsNullOrWhiteSpace(searchText))
        {
            query = query.Where(p => p.PromoCode.Contains(searchText, StringComparison.OrdinalIgnoreCase));
        }

        if (startDate.HasValue)
        {
            query = query.Where(p => p.StartDate >= startDate.Value);
        }

        if (endDate.HasValue)
        {
            if (startDate.HasValue && startDate > endDate)
            {
                
            }
            query = query.Where(p => p.EndDate <= endDate.Value);
        }

        filteredPromotions = query.ToList();

        totalPages = (int)Math.Ceiling((double)filteredPromotions.Count / pageSize);
        if (totalPages < 1) totalPages = 1;
        if (currentPage > totalPages) currentPage = totalPages;

        paginatedPromotions = filteredPromotions
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize)
            .ToList();
    }

    private void OnSearchInput(ChangeEventArgs e)
    {
        searchText = e.Value?.ToString() ?? "";
        // Reset timer, chờ 500ms sau khi ngừng gõ mới chạy 
        _debounceTimer?.Stop();
        _debounceTimer?.Start();
    }

    // Xử lý khi đổi số dòng/trang
    private void OnPageSizeChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int newSize))
        {
            pageSize = newSize;
            currentPage = 1;
            LoadData();
        }
    }

    // Xử lý chuyển trang
    private void ChangePage(int page)
    {
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        LoadData();
    }

    // Nút Reset
    private void ResetFilter()
    {
        searchText = "";
        startDate = null;
        endDate = null;
        pageSize = 5;
        currentPage = 1;
        LoadData();
    }
}