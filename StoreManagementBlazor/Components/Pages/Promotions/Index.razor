@page "/promotions"
@using System.Globalization
@using StoreManagementBlazor.Models
@using StoreManagementBlazor.Services
@inject PromotionService PromotionService
@rendermode InteractiveServer

<PageTitle>Promotions</PageTitle>

<div class="container-fluid mt-3" style="user-select: none;">
    <h2>Khuyến mãi</h2>

    <div class="row w-100 g-4 align-items-end mb-3">
        <div class="col-md-4">
            <label for="inputSearch" class="form-label">Tìm kiếm</label>
            <input type="text" autocomplete="off" class="form-control" id="inputSearch"
                   @bind="searchText"
                   @oninput="OnSearchInput"
                   placeholder="Mã khuyến mãi...">
        </div>

        <div class="col-auto">
            <label for="startDate" class="form-label">Từ ngày</label>
            <input type="date" class="form-control" id="startDate" @bind="startDate">
        </div>

        <div class="col-auto">
            <label for="endDate" class="form-label">Đến ngày</label>
            <input type="date" class="form-control" id="endDate" @bind="endDate">
        </div>

        <div class="col-auto">
            <label for="pageSizeSelect" class="form-label">Số dòng / trang</label>
            <select id="pageSizeSelect" class="form-select" @onchange="OnPageSizeChanged">
                <option value="5" selected="@(pageSize == 5)">5</option>
                <option value="10" selected="@(pageSize == 10)">10</option>
                <option value="25" selected="@(pageSize == 25)">25</option>
                <option value="50" selected="@(pageSize == 50)">50</option>
            </select>
        </div>

        <div class="col-auto">
            <button class="btn btn-primary" @onclick="LoadData">Lọc</button>
            <button class="btn btn-outline-secondary" @onclick="ResetFilter">Đặt lại</button>
        </div>
    </div>

    <p>
        <NavLink class="btn btn-primary" href="/promotions/create">Tạo mã khuyến mãi</NavLink>
    </p>

    <div class="table-responsive">
        <table class="table table-striped align-middle table-hover select-none">
            <thead>
                <tr>
                    <th>Mã</th>
                    <th>Loại giảm giá</th>
                    <th>Giá trị</th>
                    <th>Thời gian áp dụng</th>
                    <th>Trạng thái</th>
                    <th class="text-center">Hành động</th>
                </tr>
            </thead>
            <tbody>
                @if (paginatedPromotions == null || !paginatedPromotions.Any())
                {
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            @(hasFilter ? "Không có khuyến mãi phù hợp với bộ lọc." : "Chưa có dữ liệu khuyến mãi.")
                        </td>
                    </tr>
                }
                else
                {
                    foreach (var p in paginatedPromotions)
                    {
                        <tr>
                            <td>@p.PromoCode</td>
                            <td>@(p.DiscountType == "fixed" ? "Số tiền" : "Phần trăm (%)")</td>
                            <td>
                                @if (p.DiscountType == "fixed")
                                {
                                    @p.DiscountValue.ToString("N0", new CultureInfo("vi-VN"))
                                }
                                else
                                {
                                    @($"{p.DiscountValue:N0}%")
                                }
                            </td>
                            <td>
                                @p.StartDate.ToString("dd/MM/yyyy") - @p.EndDate.ToString("dd/MM/yyyy")
                            </td>
                            <td>
                                @(p.Status == "active" ? "Đang hoạt động" : "Ngưng hoạt động")
                            </td>
                            <td class="text-center align-middle">
                                <NavLink class="btn btn-info" href="@($"/promotions/details/{p.PromoId}")">Chi tiết</NavLink>
                                <NavLink class="btn btn-warning" href="@($"/promotions/edit/{p.PromoId}")">Sửa</NavLink>
                                <NavLink class="btn btn-danger" href="@($"/promotions/delete/{p.PromoId}")">Xóa</NavLink>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    @if (totalPages > 1)
    {
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                    <button class="page-link" @onclick="() => ChangePage(currentPage - 1)">&laquo; Prev</button>
                </li>

                @for (int p = 1; p <= totalPages; p++)
                {
                    if (p == 1 || p == totalPages || (p >= currentPage - 2 && p <= currentPage + 2))
                    {
                        <li class="page-item @(p == currentPage ? "active" : "")">
                            <button class="page-link" @onclick="() => ChangePage(p)">@p</button>
                        </li>
                    }
                    else if (p == 2 && currentPage > 4)
                    {
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                    }
                    else if (p == totalPages - 1 && currentPage < totalPages - 3)
                    {
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                    }
                }

                <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                    <button class="page-link" @onclick="() => ChangePage(currentPage + 1)">Next &raquo;</button>
                </li>
            </ul>
        </nav>
    }
</div>

@code {
    // === Khai báo biến trạng thái ===
    private List<Promotion> allPromotions = new(); // Dữ liệu gốc
    private List<Promotion> filteredPromotions = new(); // Dữ liệu sau khi lọc
    private List<Promotion> paginatedPromotions = new(); // Dữ liệu hiển thị trên trang hiện tại

    // Các biến Filter
    private string searchText = "";
    private DateTime? startDate;
    private DateTime? endDate;
    private bool hasFilter => !string.IsNullOrEmpty(searchText) || startDate.HasValue || endDate.HasValue;

    // Các biến Pagination
    private int currentPage = 1;
    private int pageSize = 5;
    private int totalPages = 1;

    // Timer để Debounce (chờ người dùng gõ xong mới tìm)
    private System.Timers.Timer? _debounceTimer;

    // === 2. Lifecycle ===
    protected override async Task OnInitializedAsync()
    {
        // Khởi tạo timer debounce (500ms)
        _debounceTimer = new System.Timers.Timer(500);
        _debounceTimer.AutoReset = false;
        _debounceTimer.Elapsed += async (sender, e) =>
        {
            await InvokeAsync(() => { LoadData(); StateHasChanged(); });
        };

        // Lấy toàn bộ dữ liệu lần đầu
        await LoadFullData();
    }

    // === 3. Các hàm xử lý Logic ===

    private async Task LoadFullData()
    {
        // Lưu ý: Nếu dữ liệu quá lớn, bạn nên chuyển logic lọc/phân trang xuống Service/DB (SQL)
        // Ở đây mình giả định làm việc với list trong bộ nhớ như code mẫu MVC cũ
        allPromotions = await PromotionService.GetAll();
        LoadData(); // Gọi hàm lọc và chia trang
    }

    private void LoadData()
    {
        // a. Lọc dữ liệu (Filter)
        var query = allPromotions.AsQueryable();

        if (!string.IsNullOrWhiteSpace(searchText))
        {
            query = query.Where(p => p.PromoCode.Contains(searchText, StringComparison.OrdinalIgnoreCase));
        }

        if (startDate.HasValue)
        {
            // Ép kiểu DateOnly nếu model dùng DateOnly, hoặc DateTime tùy model của bạn
            var start = DateOnly.FromDateTime(startDate.Value);
            query = query.Where(p => p.StartDate >= start);
        }

        if (endDate.HasValue)
        {
            var end = DateOnly.FromDateTime(endDate.Value);
            // Validate ngày ở UI hoặc Logic
            if (startDate.HasValue && startDate > endDate)
            {
                // Có thể hiện thông báo lỗi ở đây
            }
            query = query.Where(p => p.EndDate <= end);
        }

        filteredPromotions = query.ToList();

        // b. Tính toán phân trang
        totalPages = (int)Math.Ceiling((double)filteredPromotions.Count / pageSize);
        if (totalPages < 1) totalPages = 1;
        if (currentPage > totalPages) currentPage = totalPages;

        // c. Cắt dữ liệu (Pagination)
        paginatedPromotions = filteredPromotions
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize)
            .ToList();
    }

    // === 4. Xử lý sự kiện (Event Handlers) ===

    // Xử lý khi gõ phím tìm kiếm (Debounce)
    private void OnSearchInput(ChangeEventArgs e)
    {
        searchText = e.Value?.ToString() ?? "";
        // Reset timer, chờ 500ms sau khi ngừng gõ mới chạy lọc
        _debounceTimer?.Stop();
        _debounceTimer?.Start();
    }

    // Xử lý khi đổi số dòng/trang
    private void OnPageSizeChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int newSize))
        {
            pageSize = newSize;
            currentPage = 1; // Reset về trang 1
            LoadData();
        }
    }

    // Xử lý chuyển trang
    private void ChangePage(int page)
    {
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        LoadData();
    }

    // Nút Reset
    private void ResetFilter()
    {
        searchText = "";
        startDate = null;
        endDate = null;
        pageSize = 5;
        currentPage = 1;
        LoadData();
    }

    // Nút Xóa
    private async Task DeletePromo(int id)
    {
        // Trong thực tế nên dùng JS Interop để hiện confirm dialog
        // bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Bạn có chắc muốn xóa?");
        // if (confirmed) ...

        await PromotionService.DeletePromotion(id);
        await LoadFullData(); // Load lại dữ liệu gốc
    }
}