@page "/promotions"
@using System.Globalization
@using StoreManagementBlazor.Models
@using StoreManagementBlazor.Services
@inject PromotionService PromotionService

@rendermode InteractiveServer

<PageTitle>Promotions</PageTitle>

<div class="container-fluid mt-3" style="user-select: none;">
    <h2>Khuyến mãi</h2>

    <div class="row w-100 g-4 align-items-end mb-3">
        <div class="col-md-4">
            <label for="inputSearch" class="form-label">Tìm kiếm</label>
            <input type="text" autocomplete="off" class="form-control" id="inputSearch"
                   @bind="searchText"
                   @oninput="OnSearchInput"
                   placeholder="Mã khuyến mãi...">
        </div>

        <div class="col-auto">
            <label for="startDate" class="form-label">Từ ngày</label>
            <input type="date" class="form-control" id="startDate" @bind="startDate">
        </div>

        <div class="col-auto">
            <label for="endDate" class="form-label">Đến ngày</label>
            <input type="date" class="form-control" id="endDate" @bind="endDate">
        </div>

        <div class="col-auto">
            <label for="pageSizeSelect" class="form-label">Số dòng / trang</label>
            <select id="pageSizeSelect" class="form-select" @onchange="OnPageSizeChanged">
                <option value="5" selected="@(pageSize == 5)">5</option>
                <option value="10" selected="@(pageSize == 10)">10</option>
                <option value="25" selected="@(pageSize == 25)">25</option>
                <option value="50" selected="@(pageSize == 50)">50</option>
            </select>
        </div>

        <div class="col-auto">
            <button class="btn btn-primary"
                    @onclick="LoadData">Lọc</button>
            <button class="btn btn-outline-secondary" 
                    @onclick="ResetFilter">Đặt lại</button>
        </div>
    </div>

    <p>
        <NavLink class="btn btn-primary" href="/promotions/create">Tạo mã khuyến mãi</NavLink>
    </p>

    <div class="table-responsive">
        <table class="table table-striped align-middle table-hover select-none">
            <thead>
                <tr>
                    <th>Mã</th>
                    <th>Loại giảm giá</th>
                    <th>Giá trị</th>
                    <th>Thời gian áp dụng</th>
                    <th>Trạng thái</th>
                    <th class="text-center">Hành động</th>
                </tr>
            </thead>
            <tbody>
                @if (allPromotions == null || !allPromotions.Any())
                {
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            @(hasFilter ? "Không có khuyến mãi phù hợp." : "Đang cập nhật dữ liệu khuyến mãi.")
                        </td>
                    </tr>
                }
                else
                {
                    foreach (var p in allPromotions)
                    {
                        <tr>
                            <td>@p.PromoCode</td>
                            <td>@(p.DiscountType == "fixed" ? "Số tiền" : "Phần trăm (%)")</td>
                            <td>
                                @if (p.DiscountType == "fixed")
                                {
                                    @p.DiscountValue?.ToString("N0", new CultureInfo("vi-VN"))
                                }
                                else
                                {
                                    @($"{p.DiscountValue:N0}%")
                                }
                            </td>
                            <td>
                                @p.StartDate.ToString("dd/MM/yyyy") - @p.EndDate.ToString("dd/MM/yyyy")
                            </td>
                            <td>
                                @(p.Status == "active" ? "Đang hoạt động" : "Ngưng hoạt động")
                            </td>
                            <td class="text-center align-middle">
                                <NavLink class="btn btn-info" href="@($"/promotions/details/{p.PromoId}")">Chi tiết</NavLink>
                                <NavLink class="btn btn-warning" href="@($"/promotions/edit/{p.PromoId}")">Sửa</NavLink>
                                <NavLink class="btn btn-danger" href="@($"/promotions/delete/{p.PromoId}")">Xóa</NavLink>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">

            <!-- Prev -->
            <li class="page-item @(currentPage <= 1 ? "disabled" : "")">
                <button type="button" class="page-link"
                        style="outline:none !important; box-shadow:none !important;"
                        @onclick="() => ChangePage(currentPage - 1)"
                        disabled="@(currentPage <= 1)">
                    &laquo; Prev
                </button>
            </li>

            @{
                for (int i = 1; i <= totalPages; i++)
                {
                    int pageNumber = i; 

                    if (pageNumber == 1 || pageNumber == totalPages ||
                    (pageNumber >= currentPage - 2 && pageNumber <= currentPage + 2))
                    {
                        <li class="page-item @(pageNumber == currentPage ? "active" : "")">
                            <button type="button" class="page-link"
                                    style="outline:none !important; box-shadow:none !important;"
                                    @onclick="() => ChangePage(pageNumber)">
                                @pageNumber
                            </button>
                        </li>
                    }
                    else if (pageNumber == currentPage - 3 && currentPage > 4)
                    {
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                    }
                    else if (pageNumber == currentPage + 3 && currentPage < totalPages - 3)
                    {
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                    }
                }
            }

            <!-- Next -->
            <li class="page-item @(currentPage >= totalPages ? "disabled" : "")">
                <button type="button" class="page-link"
                        style="outline:none !important; box-shadow:none !important;"
                        @onclick="() => ChangePage(currentPage + 1)"
                        disabled="@(currentPage >= totalPages)">
                    Next &raquo;
                </button>
            </li>

        </ul>
    </nav>
</div>

@code {
    private List<Promotion> allPromotions = new(); 

    private string searchText = "";
    private DateTime? startDate;
    private DateTime? endDate;
    private bool hasFilter =>
        !string.IsNullOrWhiteSpace(searchText) || startDate.HasValue || endDate.HasValue;

    private int currentPage = 1;
    private int pageSize = 5;
    private int totalPages = 1;
    private int totalCount = 0;
   

    // Timer để Debounce (chờ người dùng gõ xong mới tìm)
    private System.Timers.Timer? _debounceTimer;

    protected override async Task OnInitializedAsync()
    {
        // Khởi tạo timer debounce (0,5s)
        _debounceTimer = new System.Timers.Timer(500);
        _debounceTimer.AutoReset = false;
        _debounceTimer.Elapsed += async (sender, e) =>
        {
            await InvokeAsync(async () => 
            { 
                currentPage = 1; 
                await LoadData(); 
                StateHasChanged(); 
            });
        };

        // Load dữ liệu lần đầu 
        await LoadData();
    }

    private async Task LoadData()
    {
        var result = await PromotionService.GetAll(
         searchText: searchText,
         startDate: startDate,
         endDate: endDate,
         page: currentPage,
         pageSize: pageSize
     );

        allPromotions = result.Promotions;
        totalCount = result.TotalCount;

        totalPages = (int)Math.Ceiling((double)totalCount / pageSize);
        if (totalPages < 1) totalPages = 1;
        if (currentPage > totalPages) currentPage = totalPages;
    }

    private void OnSearchInput(ChangeEventArgs e)
    {
        searchText = e.Value?.ToString() ?? "";
        // Reset timer, chờ 500ms sau khi ngừng gõ mới chạy 
        _debounceTimer?.Stop();
        _debounceTimer?.Start();
    }

    // Xử lý khi đổi số dòng/trang
    private async Task OnPageSizeChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int newSize))
        {
            pageSize = newSize;
            currentPage = 1;
            await LoadData();
        }
    }

    // Xử lý chuyển trang
    private async Task ChangePage(int page)
    {
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        await LoadData();
    }

    // Nút Reset
    private async Task ResetFilter()
    {
        searchText = "";
        startDate = null;
        endDate = null;
        pageSize = 5;
        currentPage = 1;
        await LoadData();
    }
}