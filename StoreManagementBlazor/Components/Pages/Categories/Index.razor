@page "/categories"
@using StoreManagementBlazor.Models
@using StoreManagementBlazor.Services
@inject CategoryService CategoryService
@inject NavigationManager Nav
@inject IJSRuntime JSRuntime
@inject Blazored.Toast.Services.IToastService toastService

@rendermode InteractiveServer

<PageTitle>Danh mục</PageTitle>

<div class="container-fluid mt-3" style="user-select:none;">
    <h2>Quản lý danh mục</h2>

    <div class="row w-100 g-3 align-items-end mb-3">
        <div class="col-md-3">
            <label class="form-label">Tìm kiếm</label>
            <input class="form-control" placeholder="Tên danh mục..."
                   @bind="searchText" @oninput="OnSearchInput" />
        </div>

        <div class="col-md-2">
            <label class="form-label">Số dòng / trang</label>
            <select class="form-select" @onchange="OnPageSizeChanged">
                <option value="5" selected="@(pageSize == 5)">5</option>
                <option value="10" selected="@(pageSize == 10)">10</option>
                <option value="25" selected="@(pageSize == 25)">25</option>
                <option value="50" selected="@(pageSize == 50)">50</option>
            </select>
        </div>

        <div class="col-auto">
            <button class="btn btn-outline-secondary" @onclick="ResetFilter">Đặt lại</button>
        </div>
    </div>

    <p>
        <NavLink class="btn btn-primary" href="/categories/create">Tạo danh mục</NavLink>
    </p>

    <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>STT</th>
                    <th>Tên danh mục</th>
                    <th class="text-center">Hành động</th>
                </tr>
            </thead>
            <tbody>
                @if (pagedCategories == null || !pagedCategories.Any())
                {
                    <tr>
                        <td colspan="3" class="text-center text-muted">Không có dữ liệu</td>
                    </tr>
                }
                else
                {
                    int stt = (currentPage - 1) * pageSize + 1;
                    foreach (var c in pagedCategories)
                    {
                        <tr>
                            <td>@stt</td>
                            <td>@c.CategoryName</td>
                            <td class="text-center">
                                <NavLink class="btn btn-warning me-1" href="@($"/categories/edit/{c.CategoryId}")">Sửa</NavLink>
                                <button class="btn btn-danger me-1" @onclick="() => ConfirmDelete(c.CategoryId, c.CategoryName)">Xóa</button>
                            </td>
                        </tr>
                        stt++;
                    }
                }
            </tbody>
        </table>
    </div>

    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">

            <!-- Prev -->
            <li class="page-item @(currentPage <= 1 ? "disabled" : "")">
                <button type="button" class="page-link"
                        style="outline:none !important; box-shadow:none !important;"
                        @onclick="() => ChangePage(currentPage - 1)"
                        disabled="@(currentPage <= 1)">
                    &laquo; Prev
                </button>
            </li>

            @{
                for (int i = 1; i <= totalPages; i++)
                {
                    int pageNumber = i; 

                    if (pageNumber == 1 || pageNumber == totalPages ||
                    (pageNumber >= currentPage - 2 && pageNumber <= currentPage + 2))
                    {
                        <li class="page-item @(pageNumber == currentPage ? "active" : "")">
                            <button type="button" class="page-link"
                                    style="outline:none !important; box-shadow:none !important;"
                                    @onclick="() => ChangePage(pageNumber)">
                                @pageNumber
                            </button>
                        </li>
                    }
                    else if (pageNumber == currentPage - 3 && currentPage > 4)
                    {
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                    }
                    else if (pageNumber == currentPage + 3 && currentPage < totalPages - 3)
                    {
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                    }
                }
            }

            <!-- Next -->
            <li class="page-item @(currentPage >= totalPages ? "disabled" : "")">
                <button type="button" class="page-link"
                        style="outline:none !important; box-shadow:none !important;"
                        @onclick="() => ChangePage(currentPage + 1)"
                        disabled="@(currentPage >= totalPages)">
                    Next &raquo;
                </button>
            </li>

        </ul>
    </nav>
    @*  *@

    
</div>

@code {
    private List<Category> pagedCategories = new();
    private string searchText = "";
    private int currentPage = 1;
    private int pageSize = 5;
    private int totalPages = 1;
    private int totalCount = 0;

    private System.Timers.Timer? _debounceTimer;

    protected override async Task OnInitializedAsync()
    {
        _debounceTimer = new System.Timers.Timer(500);
        _debounceTimer.AutoReset = false;
        _debounceTimer.Elapsed += async (sender, e) =>
        {
            await InvokeAsync(async () =>
            {
                currentPage = 1;
                await LoadData();
                StateHasChanged();
            });
        };

        await LoadData();
    }

    private async Task LoadData()
    {
        var result = await CategoryService.GetPagedAsync(currentPage, pageSize, searchText);
        pagedCategories = result.Categories;
        totalCount = result.TotalCount;
        totalPages = (int)Math.Ceiling((double)totalCount / pageSize);
        if (totalPages < 1) totalPages = 1;
        if (currentPage > totalPages) currentPage = totalPages;
    }

    private void OnSearchInput(ChangeEventArgs e)
    {
        searchText = e.Value?.ToString() ?? "";
        _debounceTimer?.Stop();
        _debounceTimer?.Start();
    }

    private async Task OnPageSizeChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int newSize))
        {
            pageSize = newSize;
            currentPage = 1;
            await LoadData();
        }
    }

    private async Task ChangePage(int page)
    {
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        await LoadData();
    }

    private async Task ResetFilter()
    {
        searchText = "";
        pageSize = 5;
        currentPage = 1;
        await LoadData();
    }

    private async Task DeleteCategory(int id)
    {
        var result = await CategoryService.DeleteAsync(id);
        if (result.success)
        {
            toastService.ShowSuccess(result.message);
            await LoadData();
        }
        else
        {
            toastService.ShowError(result.message);
        }
    }

    private async Task ConfirmDelete(int id, string categoryName)
{
    // Hiển thị confirm popup
    bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Bạn có chắc chắn muốn xóa danh mục '{categoryName}'?");

    if (!confirmed)
        return;

    // Xóa category
    var result = await CategoryService.DeleteAsync(id);

    if (result.success)
    {
        toastService.ShowSuccess(result.message);
        await LoadData(); // reload lại danh sách
    }
    else
    {
        toastService.ShowError(result.message);
    }
}

}
