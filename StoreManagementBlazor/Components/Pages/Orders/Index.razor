@page "/orders"
@rendermode InteractiveServer
@using StoreManagementBlazor.Models.ViewModels
@using StoreManagementBlazor.Services

@inject OrdersService OrdersService
@inject NavigationManager NavigationManager

<PageTitle>Quản lý đơn hàng</PageTitle>

<div class="container-fluid mt-3" style="user-select:none;">

    <h2>Quản lý đơn hàng</h2>

    <p>
        <a href="/orders/create" class="btn btn-primary">
            + Tạo đơn hàng mới
        </a>
    </p>

    @* Thông báo *@
    @if (!string.IsNullOrEmpty(SuccessMessage))
    {
        <div class="alert alert-success alert-dismissible fade show">
            @SuccessMessage
            <button type="button" class="btn-close"
                    @onclick="() => SuccessMessage = null">
            </button>
        </div>
    }

    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show">
            @ErrorMessage
            <button type="button" class="btn-close"
                    @onclick="() => ErrorMessage = null">
            </button>
        </div>
    }

    @* FILTER *@
    <div class="row w-100 g-4 align-items-end mb-3">

        <div class="col-md-2">
            <label class="form-label">Tên khách</label>
            <InputText class="form-control"
                       placeholder="Nhập tên"
                       @bind-Value="Filter.SearchCustomer" />
        </div>

        <div class="col-md-2">
            <label class="form-label">Ngày tạo</label>
            <InputText class="form-control"
                       placeholder="dd/MM/yyyy"
                       @bind-Value="Filter.SearchDate" />
        </div>

        <div class="col-md-2">
            <label class="form-label">Từ (₫)</label>
            <InputNumber class="form-control"
                         placeholder="Min giá"
                         @bind-Value="Filter.MinPrice" />
        </div>

        <div class="col-md-2">
            <label class="form-label">Đến (₫)</label>
            <InputNumber class="form-control"
                         placeholder="Max giá"
                         @bind-Value="Filter.MaxPrice" />
        </div>

        <div class="col-md-2">
            <label class="form-label">Trạng thái</label>
            <InputSelect class="form-select"
                         @bind-Value="Filter.Status">
                <option value="">Tất cả</option>
                <option value="pending">Chưa thanh toán</option>
                <option value="paid">Đã thanh toán</option>
                <option value="canceled">Đã hủy</option>
            </InputSelect>
        </div>

        <div class="col-auto d-grid">
            <button class="btn btn-primary" @onclick="ApplyFilter">
                Lọc
            </button>
        </div>

        <div class="col-auto d-grid">
            <button class="btn btn-outline-secondary" @onclick="ClearFilter">
                Đặt lại
            </button>
        </div>

    </div>

    @* DATA *@
    @if (IsLoading)
    {
        <p><em>Đang tải dữ liệu...</em></p>
    }
    else if (PagingResult == null || !PagingResult.Items.Any())
    {
        <div class="alert alert-info">
            Không tìm thấy đơn hàng nào khớp với điều kiện.
        </div>
    }
    else
    {
        <table class="table table-hover align-middle text-center mt-3"
               style="table-layout:fixed;">

            <thead class="table-light">
                <tr>
                    <th style="width:8%"># Mã</th>
                    <th style="width:22%" class="text-start">Khách hàng</th>
                    <th style="width:18%">Ngày tạo</th>
                    <th style="width:15%" class="text-end">Tổng tiền</th>
                    <th style="width:15%">Trạng thái</th>
                    <th style="width:22%">Hành động</th>
                </tr>
            </thead>

            <tbody>
                @foreach (var item in PagingResult.Items)
                {
                    <tr>
                        <td>#@item.OrderId</td>

                        <td class="text-start">
                            @item.CustomerName
                        </td>

                        <td>@item.OrderDate.ToString("dd/MM/yyyy HH:mm")</td>

                        <td class="text-end fw-bold text-danger">
                            @item.TotalAmount.ToString("N0") ₫
                        </td>

                        <td>
                            @if (item.Status == "paid")
                            {
                                <span class="badge bg-success">Đã thanh toán</span>
                            }
                            else if (item.Status == "canceled")
                            {
                                <span class="badge bg-danger">Đã hủy</span>
                            }
                            else
                            {
                                <span class="badge bg-warning text-dark">Chưa thanh toán</span>
                            }
                        </td>

                        <td>
                            <div class="d-flex justify-content-center gap-2">
                                <a href="/orders/details/@item.OrderId"
                                   class="btn btn-sm btn-info text-white">
                                    Chi tiết & thanh toán
                                </a>

                                @if (item.Status == "pending")
                                {
                                    <a href="/orders/delete/@item.OrderId"
                                       class="btn btn-sm btn-outline-danger">
                                        Xóa
                                    </a>
                                }
                                else
                                {
                                    <button class="btn btn-sm btn-secondary" disabled>
                                        Đã xong
                                    </button>
                                }
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        @* PAGINATION *@
        <nav>
            <ul class="pagination justify-content-center">
                <li class="page-item @(PagingResult.Page == 1 ? "disabled" : "")">
                    <a class="page-link" href="javascript:void(0)" 
                       @onclick="() => GoToPage(PagingResult.Page - 1)">« Previous</a>
                </li>

                @for (int i = 1; i <= PagingResult.TotalPages; i++)
                {
                    <li class="page-item @(i == PagingResult.Page ? "active" : "")">
                        <a class="page-link" href="javascript:void(0)" 
                           @onclick="() => GoToPage(i)">@i</a>
                    </li>
                }

                <li class="page-item @(PagingResult.Page == PagingResult.TotalPages || PagingResult.TotalPages == 0 ? "disabled" : "")">
                    <a class="page-link" href="javascript:void(0)" 
                       @onclick="() => GoToPage(PagingResult.Page + 1)">Next »</a>
                </li>
            </ul>
        </nav>
    }
</div>

@code {
    private PagedResult<OrderListDTO>? PagingResult;
    private OrderFilterDTO Filter = new();
    private bool IsLoading = true;

    [SupplyParameterFromQuery(Name = "success")]
    public string? SuccessMessage { get; set; }

    [SupplyParameterFromQuery(Name = "error")]
    public string? ErrorMessage { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadOrders();
    }

    private async Task LoadOrders()
    {
        IsLoading = true;
        PagingResult = await OrdersService.GetOrdersAsync(Filter);
        IsLoading = false;
        StateHasChanged();
    }

    private async Task ApplyFilter()
    {
        Filter.Page = 1;
        await LoadOrders();
    }

    private async Task ClearFilter()
    {
        Filter = new OrderFilterDTO { PageSize = Filter.PageSize };
        await LoadOrders();
    }

    private async Task GoToPage(int page)
    {
        if (page >= 1 && (PagingResult == null || page <= PagingResult.TotalPages))
        {
            Filter.Page = page;
            await LoadOrders();
        }
    }

    private async Task SortBy(string sortField)
    {
        Filter.SortBy = sortField;
        Filter.Page = 1;
        await LoadOrders();
    }
}
