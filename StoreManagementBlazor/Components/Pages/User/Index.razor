@page "/users"
@rendermode InteractiveServer
@using StoreManagementBlazor.Models.ViewModels
@using StoreManagementBlazor.Services
@inject UserService UserService
@inject NavigationManager NavManager
@inject IJSRuntime JS  // <--- THÊM DÒNG NÀY ĐỂ GỌI JAVASCRIPT

<PageTitle>Quản lý nhân sự</PageTitle>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Danh sách Nhân sự (Admin & Staff)</h3>
        <a href="/users/create" class="btn btn-primary">
            <i class="bi bi-plus-lg"></i> Thêm mới
        </a>
    </div>

    <table class="table table-bordered table-hover">
        <thead class="table-light">
            <tr>
                <th>ID</th>
                <th>Tên đăng nhập</th>
                <th>Họ tên</th>
                <th>Vai trò</th>
                <th>Điện thoại</th>
                <th>Email</th>
                <th>Thao tác</th>
            </tr>
        </thead>
        <tbody>
            @if (Users == null)
            {
                <tr><td colspan="7" class="text-center">Đang tải...</td></tr>
            }
            else if (!Users.Any())
            {
                <tr><td colspan="7" class="text-center">Không có dữ liệu</td></tr>
            }
            else
            {
                @foreach (var user in Users)
                {
                    <tr>
                        <td>@user.UserId</td>
                        <td>@user.Username</td>
                        <td>@user.FullName</td>
                        <td>
                            @if (user.Role == "admin")
                            {
                                <span class="badge bg-danger">Quản trị viên</span>
                            }
                            else if (user.Role == "customer") 
                            {
                                <span class="badge bg-success">Khách hàng</span>
                            }
                            else
                            {
                                <span class="badge bg-primary">Nhân viên</span>
                            }
                        </td>
                        <td>@(user.Phone ?? "-")</td>
                        <td>@(user.Email ?? "-")</td>
                        <td>
                            <a href="/users/edit/@user.UserId" class="btn btn-sm btn-warning">Sửa</a>
                            <button class="btn btn-sm btn-danger" @onclick="() => DeleteUser(user.UserId)">Xóa</button>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>

@code {
    private List<UserAdminViewModel>? Users;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        Users = await UserService.GetAllUsersAsync();
    }

    private async Task DeleteUser(int id)
    {
        // --- SỬA ĐOẠN NÀY ---
        // Sử dụng JS Interop để gọi hộp thoại confirm của trình duyệt
        bool confirmed = await JS.InvokeAsync<bool>("confirm", "Bạn có chắc muốn xóa nhân sự này không?");
        
        if (confirmed)
        {
            await UserService.DeleteUserAsync(id);
            await LoadData(); // Tải lại danh sách sau khi xóa
        }
        // --------------------
    }
}